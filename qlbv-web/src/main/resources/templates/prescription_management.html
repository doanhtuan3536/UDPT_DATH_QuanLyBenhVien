<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đơn thuốc - Hệ thống Quản lý Bệnh viện</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome cho biểu tượng -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/prescription_management.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .wrapper {
            flex-grow: 1;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 5%; /* Sử dụng phần trăm để responsive tốt hơn */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info a {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
        }

        .user-info a:hover {
            background-color: #c0392b;
        }



        .footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 1.5rem;
        }

        @media (max-width: 768px) {

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 1rem;
            }
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }


    </style>
</head>
<body>

<div class="wrapper">
    <div th:replace="header :: header">...</div>

    <div class="container">
        <a href="/home" class="back-link">
            <i class="fas fa-arrow-left"></i> Quay lại trang chủ
        </a>

        <h1 class="page-title">Quản lý Đơn thuốc</h1>

        <div class="status-tabs">
            <div class="status-tab active" data-status="not-ready">Chưa sẵn sàng</div>
            <div class="status-tab" data-status="ready">Sẵn sàng</div>
            <div class="status-tab" data-status="taken">Đã lấy</div>
            <div class="status-tab" data-status="not-taken">Chưa lấy</div>
        </div>

        <div class="prescriptions-container" id="prescriptionsList">
        </div>
    </div>
</div>

<div th:replace="footer :: footer">...</div>

<div class="modal fade" id="prescriptionDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết đơn thuốc</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer" id="modalFooter">
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const prescriptionsData = [
            {
                id: 1,
                prescriptionCode: "ĐT-2023-001",
                patientName: "Nguyễn Văn A",
                patientId: "BN001",
                doctorName: "BS. Trần Văn B",
                createdAt: "2023-10-25 14:30:00",
                status: "not-ready",
                totalPrice: 185000,
                medicines: [
                    { id: 1, name: "Paracetamol 500mg", quantity: 2, price: 2000, total: 4000 },
                    { id: 2, name: "Amoxicillin 250mg", quantity: 1, price: 3500, total: 3500 },
                    { id: 3, name: "Vitamin C 100mg", quantity: 3, price: 1500, total: 4500 }
                ]
            },
            {
                id: 2,
                prescriptionCode: "ĐT-2023-002",
                patientName: "Lê Thị C",
                patientId: "BN002",
                doctorName: "BS. Nguyễn Thị D",
                createdAt: "2023-10-26 09:15:00",
                status: "ready",
                totalPrice: 275000,
                medicines: [
                    { id: 4, name: "Omeprazole 20mg", quantity: 1, price: 4500, total: 4500 },
                    { id: 5, name: "Metformin 500mg", quantity: 2, price: 3000, total: 6000 }
                ]
            },
            {
                id: 3,
                prescriptionCode: "ĐT-2023-003",
                patientName: "Phạm Văn E",
                patientId: "BN003",
                doctorName: "BS. Trần Văn B",
                createdAt: "2023-10-27 11:20:00",
                status: "not-ready",
                totalPrice: 120000,
                medicines: [
                    { id: 6, name: "Loratadine 10mg", quantity: 2, price: 2200, total: 4400 },
                    { id: 7, name: "Aspirin 81mg", quantity: 1, price: 1800, total: 1800 }
                ]
            },
            {
                id: 4,
                prescriptionCode: "ĐT-2023-004",
                patientName: "Hoàng Thị F",
                patientId: "BN004",
                doctorName: "BS. Nguyễn Thị D",
                createdAt: "2023-10-28 15:45:00",
                status: "taken",
                totalPrice: 210000,
                medicines: [
                    { id: 8, name: "Ibuprofen 400mg", quantity: 1, price: 2500, total: 2500 }
                ]
            },
            {
                id: 5,
                prescriptionCode: "ĐT-2023-005",
                patientName: "Vũ Văn G",
                patientId: "BN005",
                doctorName: "BS. Trần Văn B",
                createdAt: "2023-10-29 10:30:00",
                status: "not-taken",
                totalPrice: 165000,
                medicines: [
                    { id: 1, name: "Paracetamol 500mg", quantity: 3, price: 2000, total: 6000 },
                    { id: 3, name: "Vitamin C 100mg", quantity: 2, price: 1500, total: 3000 }
                ]
            }
        ];

        const prescriptionsList = document.getElementById('prescriptionsList');
        const statusTabs = document.querySelectorAll('.status-tab');
        let currentFilter = 'not-ready';
        let currentPrescriptionId = null;

        // Hiển thị danh sách đơn thuốc
        function renderPrescriptions(filter = 'not-ready') {
            prescriptionsList.innerHTML = '';

            const filteredPrescriptions = prescriptionsData.filter(p => p.status === filter);

            if (filteredPrescriptions.length === 0) {
                prescriptionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-pills"></i>
                        <p>Không có đơn thuốc nào trong danh mục này</p>
                    </div>
                `;
                return;
            }

            filteredPrescriptions.forEach(prescription => {
                const statusText = getStatusText(prescription.status);
                const statusClass = getStatusClass(prescription.status);

                const prescriptionCard = document.createElement('div');
                prescriptionCard.className = `prescription-card ${prescription.status}`;
                prescriptionCard.dataset.id = prescription.id;

                prescriptionCard.innerHTML = `
                    <div class="prescription-header">
                        <div class="prescription-id">
                            ${prescription.prescriptionCode}
                        </div>
                        <span class="prescription-status ${statusClass}">${statusText}</span>
                    </div>

                    <div class="prescription-info">
                        <div class="info-item">
                            <span class="info-label">Bệnh nhân:</span>
                            <span>${prescription.patientName} (ID: ${prescription.patientId})</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Bác sĩ:</span>
                            <span>${prescription.doctorName}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ngày tạo:</span>
                            <span>${formatDateTime(prescription.createdAt)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Số loại thuốc:</span>
                            <span>${prescription.medicines.length}</span>
                        </div>
                    </div>

                    <div class="prescription-footer">
                        <div class="total-price">${formatCurrency(prescription.totalPrice)} VNĐ</div>
                        <button class="btn btn-primary btn-sm view-details-btn">
                            <i class="fas fa-eye"></i> Xem chi tiết
                        </button>
                    </div>
                `;

                prescriptionsList.appendChild(prescriptionCard);

                // Thêm sự kiện click cho nút xem chi tiết
                const viewDetailsBtn = prescriptionCard.querySelector('.view-details-btn');
                viewDetailsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showPrescriptionDetails(prescription.id);
                });

                // Thêm sự kiện click cho toàn bộ card
                prescriptionCard.addEventListener('click', function() {
                    showPrescriptionDetails(prescription.id);
                });
            });
        }

        // Hiển thị chi tiết đơn thuốc trong modal
        function showPrescriptionDetails(prescriptionId) {
            const prescription = prescriptionsData.find(p => p.id === prescriptionId);
            if (!prescription) return;

            currentPrescriptionId = prescriptionId;
            const statusText = getStatusText(prescription.status);
            const statusClass = getStatusClass(prescription.status);

            let medicinesHTML = '';
            prescription.medicines.forEach(med => {
                medicinesHTML += `
                    <div class="medicine-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${med.name} (ID: ${med.id})</h6>
                                <p class="text-muted mb-0">Số lượng: ${med.quantity}</p>
                            </div>
                            <div class="text-end">
                                <p class="mb-0 text-muted">Đơn giá: ${formatCurrency(med.price)} VNĐ</p>
                                <p class="mb-0 fw-bold">Thành tiền: ${formatCurrency(med.total)} VNĐ</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Mã đơn thuốc:</label>
                                    <p class="mb-0">${prescription.prescriptionCode}</p>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Ngày tạo:</label>
                                    <p class="mb-0">${formatDateTime(prescription.createdAt)}</p>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Bác sĩ kê đơn:</label>
                                    <p class="mb-0">${prescription.doctorName}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Bệnh nhân:</label>
                                    <p class="mb-0">${prescription.patientName} (ID: ${prescription.patientId})</p>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Tình trạng đơn thuốc:</label>
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-pills me-2"></i>DANH SÁCH THUỐC
                        </h6>
                    </div>
                    <div class="card-body">
                        ${medicinesHTML}
                        <div class="border-top pt-3 mt-3 text-end">
                            <p class="total-price">Tổng tiền: ${formatCurrency(prescription.totalPrice)} VNĐ</p>
                        </div>
                    </div>
                </div>
            `;

            // Cập nhật nút hành động dựa trên trạng thái
            const modalFooter = document.getElementById('modalFooter');
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            `;

            if (prescription.status === 'not-ready') {
                modalFooter.innerHTML += `
                    <button type="button" class="btn btn-success" id="markAsReadyBtn">
                        <i class="fas fa-check-circle"></i> Đánh dấu là sẵn sàng
                    </button>
                `;
            } else if (prescription.status === 'ready') {
                modalFooter.innerHTML += `
                    <div class="action-buttons">
                        <button type="button" class="btn btn-info" id="markAsTakenBtn">
                            <i class="fas fa-check"></i> Đã lấy thuốc
                        </button>
                        <button type="button" class="btn btn-warning" id="markAsNotTakenBtn">
                            <i class="fas fa-times"></i> Chưa lấy thuốc
                        </button>
                    </div>
                `;
            }

            // Hiển thị modal
            const modal = new bootstrap.Modal(document.getElementById('prescriptionDetailModal'));
            modal.show();

            // Thêm sự kiện cho các nút hành động
            setupActionButtons(prescription);
        }

        function setupActionButtons(prescription) {
            // Nút "Đánh dấu là sẵn sàng"
            const markAsReadyBtn = document.getElementById('markAsReadyBtn');
            if (markAsReadyBtn) {
                markAsReadyBtn.addEventListener('click', function() {
                    updatePrescriptionStatus(prescription.id, 'ready');
                });
            }

            // Nút "Đã lấy thuốc"
            const markAsTakenBtn = document.getElementById('markAsTakenBtn');
            if (markAsTakenBtn) {
                markAsTakenBtn.addEventListener('click', function() {
                    updatePrescriptionStatus(prescription.id, 'taken');
                });
            }

            // Nút "Chưa lấy thuốc"
            const markAsNotTakenBtn = document.getElementById('markAsNotTakenBtn');
            if (markAsNotTakenBtn) {
                markAsNotTakenBtn.addEventListener('click', function() {
                    updatePrescriptionStatus(prescription.id, 'not-taken');
                });
            }
        }

        // Cập nhật trạng thái đơn thuốc
        function updatePrescriptionStatus(prescriptionId, newStatus) {
            const prescriptionIndex = prescriptionsData.findIndex(p => p.id === prescriptionId);
            if (prescriptionIndex !== -1) {
                prescriptionsData[prescriptionIndex].status = newStatus;

                // Cập nhật giao diện
                renderPrescriptions(currentFilter);

                // Đóng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('prescriptionDetailModal'));
                modal.hide();

                // Hiển thị thông báo
                const statusText = getStatusText(newStatus);
                alert(`Đơn thuốc đã được cập nhật thành: ${statusText}`);
            }
        }

        // Xử lý sự kiện cho các tab trạng thái
        statusTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                statusTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                currentFilter = this.dataset.status;
                renderPrescriptions(currentFilter);
            });
        });

        function getStatusText(status) {
            switch(status) {
                case 'ready': return 'Sẵn sàng';
                case 'not-ready': return 'Chưa sẵn sàng';
                case 'taken': return 'Đã lấy';
                case 'not-taken': return 'Chưa lấy';
                default: return 'Không xác định';
            }
        }
        function getStatusClass(status) {
            switch(status) {
                case 'ready': return 'status-ready';
                case 'not-ready': return 'status-not-ready';
                case 'taken': return 'status-taken';
                case 'not-taken': return 'status-not-taken';
                default: return '';
            }
        }
        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }
        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Khởi tạo hiển thị
        renderPrescriptions();
    });
</script>
</body>
</html>