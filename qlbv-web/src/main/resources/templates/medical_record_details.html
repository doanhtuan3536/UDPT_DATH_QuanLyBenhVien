<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Hồ Sơ Bệnh Án</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .timeline {
            border-left: 3px solid #0d6efd;
            border-bottom-right-radius: 4px;
            border-top-right-radius: 4px;
            position: relative;
            margin: 20px 0;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 25px;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0d6efd;
            border: 3px solid white;
        }
        .exam-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .exam-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .wrapper {
            flex-grow: 1;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 5%; /* Sử dụng phần trăm để responsive tốt hơn */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info a {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
        }

        .user-info a:hover {
            background-color: #c0392b;
        }
        .footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 1.5rem;
        }

        @media (max-width: 768px) {

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="bg-light">
<div class="wrapper">
    <div th:replace="header :: header">...</div>
    <div class="container mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/home">Trang Chủ</a></li>
                <li class="breadcrumb-item">
                    <a th:href="${#authentication.principal.authResponse.role == 'bacsi'}
                       ? '/medical-records/' + ${record.userId}
                       : '/medical-records'">
                        Hồ Sơ Bệnh Án
                    </a>
                </li>
                <li class="breadcrumb-item active" th:text="'HSBA-' + ${record.medicalRecordId}">HSBA-2023-0015</li>
            </ol>
        </nav>

        <!-- Check if record exists -->
        <div th:if="${record != null}">
            <!-- Medical Record Header -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-medical me-2"></i>HỒ SƠ BỆNH ÁN #HSBA-<span th:text="${record.medicalRecordId}">0015</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="fw-bold text-muted">Ngày tạo hồ sơ:</label>
                                <p class="mb-0" th:text="${#temporals.format(record.createdAt, 'dd/MM/yyyy')}">25/10/2023</p>
                            </div>
                            <div class="mb-3">
                                <label class="fw-bold text-muted">Bác sĩ điều trị chính:</label>
                                <div class="d-flex align-items-center">
                                    <span th:text="'BS. ' + ${record.doctorName} + ' (id: '+ ${record.doctorId} + ')'">BS. Nguyễn Văn A</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="fw-bold text-muted">Tình trạng hiện tại:</label>
                                <span th:classappend="${record.status == 'discharged'} ? 'bg-success' : 'bg-warning'"
                                      class="badge" th:text="${record.status == 'discharged'} ? 'Đã kết thúc điều trị' : 'Đang điều trị'">
                                        Đã kết thúc điều trị
                                    </span>
                            </div>
                            <div class="mb-3" th:if="${record.dischargeSummary != null and !record.dischargeSummary.isEmpty()}">
                                <label class="fw-bold text-muted">Tóm tắt điều trị:</label>
                                <p class="mb-0" th:text="${record.dischargeSummary}">Nhập viện vì đau bụng dữ dội. Đã nội soi và điều trị nội khoa. Sức khỏe ổn định và xuất viện sau 3 ngày.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3" th:if="${record.healthCondition != null and !record.healthCondition.isEmpty()}">
                        <label class="fw-bold text-muted">Tình trạng sức khỏe chi tiết:</label>
                        <div class="border rounded p-3 bg-light">
                            <p class="mb-0" th:text="${record.healthCondition}">Bệnh nhân nhập viện với triệu chứng đau bụng vùng thượng vị. Kết quả nội soi chẩn đoán viêm dạ dày cấp. Đã điều trị bằng thuốc kháng acid và thay đổi chế độ ăn uống. Tình trạng ổn định, cần tái khám sau 1 tuần.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Examination History -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>LỊCH SỬ THĂM KHÁM
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Check if there are examinations -->
                    <div th:if="${record.examinations != null and !record.examinations.empty}">
                        <!-- Timeline View for Examinations -->
                        <div class="timeline">
                            <!-- Examination Item Template -->
                            <div th:each="exam, iterStat : ${record.examinations}" class="timeline-item">
                                <div class="card exam-card mb-3">
                                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">
                                                <span th:text="${#temporals.format(exam.date, 'dd/MM/yyyy')}">27/10/2023</span> -
                                                <span th:text="${exam.time}">08:30</span>
                                            </h6>
                                            <small class="text-muted" th:text="'BS. ' + ${exam.doctorName} + ' (id: '+ ${exam.doctorId} + ')'">BS. Trần Thị C</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" th:attr="data-bs-target='#examDetail' + ${iterStat.index}" data-bs-toggle="collapse">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text" th:if="${exam.assessment_note != null and !exam.assessment_note.isEmpty()}">
                                            <strong>Chẩn đoán:</strong> <span th:text="${exam.assessment_note}">Kiểm tra cuối đợt điều trị, tình trạng ổn định</span>
                                        </p>
<!--                                        <div th:if="${exam.prescriptionId != null}" class="mt-2">-->
<!--                                            <a th:href="@{'/medical-records/prescriptions/' + ${exam.prescriptionId}}"-->
<!--                                               class="btn btn-outline-success btn-sm">-->
<!--                                                <i class="fas fa-prescription me-1"></i> Xem đơn thuốc #<span th:text="${exam.prescriptionId}"></span>-->
<!--                                            </a>-->
<!--                                        </div>-->
                                        <div class="mt-2">
                                            <a th:href="@{'/medical-records/prescriptions/' + ${exam.examinationId} + '/' + ${record.medicalRecordId}}"
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-prescription me-1"></i> Xem đơn thuốc của lịch khám # <span th:text="${exam.examinationId}">1</span>
                                            </a>
                                        </div>
                                        <div th:attr="id='examDetail' + ${iterStat.index}" class="collapse">
                                            <div class="mt-3">
                                                <h6 th:if="${exam.subjective_note != null and !exam.subjective_note.isEmpty()}">Triệu chứng chủ quan:</h6>
                                                <p class="text-muted" th:text="${exam.subjective_note}">Bệnh nhân cho biết không còn đau bụng, ăn uống ngon miệng.</p>

                                                <h6 th:if="${exam.objective_note != null and !exam.objective_note.isEmpty()}">Triệu chứng khách quan:</h6>
                                                <p class="text-muted" th:text="${exam.objective_note}">Da dẻ hồng hào, bụng mềm, không đau khi ấn.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State for Examinations -->
                    <div th:if="${record.examinations == null or record.examinations.empty}" class="text-center py-4" id="emptyExams">
                        <i class="fas fa-stethoscope fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Chưa có lịch sử thăm khám nào cho hồ sơ này</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Show message if record doesn't exist -->
        <div th:if="${record == null}" class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle me-2"></i>Không tìm thấy thông tin hồ sơ bệnh án
        </div>
    </div>
</div>

<div th:replace="footer :: footer">...</div>

<!-- Main Content -->


</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // JavaScript để xử lý collapse và các tương tác khác
    document.addEventListener('DOMContentLoaded', function() {
        // Kiểm tra nếu không có lần khám nào
        const timeline = document.querySelector('.timeline');
        const emptyExams = document.getElementById('emptyExams');

        if (timeline.children.length === 0) {
            emptyExams.classList.remove('d-none');
        }

        // Xử lý sự kiện click cho các card
        const examCards = document.querySelectorAll('.exam-card');
        examCards.forEach(card => {
            card.addEventListener('click', function(e) {
                if (!e.target.closest('.btn')) {
                    const collapseId = this.querySelector('[data-bs-toggle="collapse"]').dataset.bsTarget;
                    const collapseElement = document.querySelector(collapseId);
                    new bootstrap.Collapse(collapseElement).toggle();
                }
            });
        });
    });
</script>
</body>
</html>